<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Web sockets test</title>

    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <style type="text/css">
        .row{
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .textSpan{

        }
    </style>

</head>
<body>

    <div class="container">
        <form id="form1" runat="server" class="form-inline">
            <div class="col-md-12">
                <h1>Web Socket 聊天室</h1>
            </div>
            <div class="col-md-8">
                <div class="col-md-12 row">
                    按下连接按钮，会通过WebSocket发起一个到聊天浏览器的连接。
                </div>
                <div class="col-md-12 row">
                    <div class="form-group col-md-12">
                        <div class="input-group col-md-8">
                        <label for="Connection" class="input-group-addon"><span class="glyphicon glyphicon-globe" aria-hidden="true"> 服务器地址：</span></label>
                        <input type="text" class="form-control" id="Connection">
                        </div>
                    </div>
                </div>
                <div class="col-md-12 row">
                    <div class="form-group col-md-12">
                        <div class="input-group col-md-8">
                            <label for="txtName" class="input-group-addon"><span class="glyphicon glyphicon-user" aria-hidden="true"> 用　户　名：</span></label>
                            <input type="text" id="txtName" class="form-control" value="Test"/>
                        </div>
                        <div class="col-md-4 pull-right">
                            <button id='ToggleConnection' class="btn btn-primary" type="button" onclick='ToggleConnectionClicked();'>连 接</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 row">
                    <div class="panel panel-default" style="height: 300px;overflow: auto">
                        <div class="panel-body"  id='LogContainer' style="height:0px;padding-bottom:100%;word-break: break-all;">

                        </div>
                    </div>
                </div>
                <div id='SendDataContainer' class="col-md-12 row">
                        <div class="input-group col-md-10">
                            <input type="text" id="DataToSend" class="form-control" placeholder="请输入...">
                           <span class="input-group-btn">
                            <button class="btn btn-info"  id='SendData' type="button" onclick='SendDataClicked();'>发 送</button>
                           </span>
                        </div><!-- /input-group -->
                </div>
            </div>
            <div class="col-md-4">
                <div id="skm_LockPane" class="LockOff"></div>
            </div>
        </form>
    </div>


</body>

<script type="text/javascript">
    var ws;
    var SocketCreated = false;
    var isUserloggedout = false;

    function lockOn(str)
    {
        var lock = document.getElementById('skm_LockPane');
        if (lock)
            lock.className = 'LockOn';
        lock.innerHTML = str;
    }

    function lockOff()
    {
        var lock = document.getElementById('skm_LockPane');
        lock.className = 'LockOff';
    }

    /*链接WebSocket*/
    function ToggleConnectionClicked() {
        if (SocketCreated && (ws.readyState == 0 || ws.readyState == 1)) {
            lockOn("离开聊天室...");
            SocketCreated = false;
            isUserloggedout = true;
            ws.close();
        } else {
            lockOn("进入聊天室...");
            Log("准备连接到聊天服务器 ...");
            try {
                if ("WebSocket" in window) {
                    ws = new WebSocket("ws://" + document.getElementById("Connection").value);
                }
                else if("MozWebSocket" in window) {
                    ws = new MozWebSocket("ws://" + document.getElementById("Connection").value);
                }

                SocketCreated = true;
                isUserloggedout = false;
            } catch (ex) {
                Log(ex, "ERROR");
                return;
            }
            document.getElementById("ToggleConnection").innerHTML = "断 开";
            ws.onopen = WSonOpen;
            ws.onmessage = WSonMessage;
            ws.onclose = WSonClose;
            ws.onerror = WSonError;
        }
    };

    function WSonOpen() {
        lockOff();
        Log("连接已经建立。", "OK");
        $("#SendDataContainer").show();
        ws.send("login:" + document.getElementById("txtName").value);
    };

    function WSonMessage(event) {
        Log(event.data);
    };

    function WSonClose() {
        lockOff();
        if (isUserloggedout)
            Log("【"+document.getElementById("txtName").value+"】离开了聊天室！");
        document.getElementById("ToggleConnection").innerHTML = "连接";
        $("#SendDataContainer").hide();
    };

    function WSonError() {
        lockOff();
        Log("远程连接中断。", "ERROR");
    };

    /*发送消息*/
    function SendDataClicked() {
        if (document.getElementById("DataToSend").value.trim() != "") {
            ws.send(document.getElementById("txtName").value + "说 :\"" + document.getElementById("DataToSend").value + "\"");
            document.getElementById("DataToSend").value = "";
        }
    };

    /*输出到文本框*/
    function Log(Text, MessageType) {
        if (MessageType == "OK") Text = "<span style='color: green;'>" + Text + "</span>";
        if (MessageType == "ERROR") Text = "<span style='color: red;'>" + Text + "</span>";
        document.getElementById("LogContainer").innerHTML = document.getElementById("LogContainer").innerHTML + Text + "<br />";
        var LogContainer = document.getElementById("LogContainer");
        LogContainer.scrollTop = LogContainer.scrollHeight;
    };

    $(document).ready(function () {

        $("#SendDataContainer").hide();  //隐藏发送消息框

        /*验证浏览器是否支持WebSocket*/
        var WebSocketsExist = true;
        try {
            var dummy = new WebSocket("ws://45.78.46.180:80/test");
        } catch (ex) {
            try
            {
                webSocket = new MozWebSocket("ws://45.78.46.180:80/test");
            }
            catch(ex)
            {
                WebSocketsExist = false;
            }
        }

        if (WebSocketsExist) {
            Log("您的浏览器支持WebSocket. 您可以尝试连接到聊天服务器!", "OK");
            document.getElementById("Connection").value = "localhost:8088/WebSocketChat/chat";
        } else {
            Log("您的浏览器不支持WebSocket。请选择其他的浏览器再尝试连接服务器。", "ERROR");
            document.getElementById("ToggleConnection").disabled = true;
        }

        /*回车键发送消息*/
        $("#DataToSend").keypress(function(evt)
        {
            if (evt.keyCode == 13)
            {
                $("#SendData").click();
                evt.preventDefault();
            }
        })
    });
</script>
</html>

